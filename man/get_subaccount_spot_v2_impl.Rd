% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/impl_account_sub_account.R
\name{get_subaccount_spot_v2_impl}
\alias{get_subaccount_spot_v2_impl}
\title{Retrieve Spot Sub-Account List - Balance Details (V2) (Implementation)}
\usage{
get_subaccount_spot_v2_impl(
  keys = get_api_keys(),
  base_url = get_base_url(),
  page_size = 100,
  max_pages = Inf,
  .__coro_env_parent__ = <environment>
)
}
\arguments{
\item{keys}{List containing API configuration parameters from \code{get_api_keys()}, including:
\itemize{
\item \code{api_key}: Character string; your KuCoin API key.
\item \code{api_secret}: Character string; your KuCoin API secret.
\item \code{api_passphrase}: Character string; your KuCoin API passphrase.
\item \code{key_version}: Character string; API key version (e.g., \code{"2"}).
Defaults to \code{get_api_keys()}.
}}

\item{base_url}{Character string representing the base URL for the API. Defaults to \code{get_base_url()}.}

\item{page_size}{Integer specifying the number of results per page (minimum 10, maximum 100). Defaults to 100.}

\item{max_pages}{Numeric specifying the maximum number of pages to fetch (defaults to \code{Inf}, fetching all available pages).}
}
\value{
Promise resolving to a \code{data.table} containing aggregated sub-account balance information, with columns including:
\itemize{
\item \code{subUserId} (character): Sub-account user ID.
\item \code{subName} (character): Sub-account name.
\item \code{accountType} (character): Type of account (e.g., \code{"mainAccounts"}, \code{"tradeAccounts"}, \code{"marginAccounts"}, \code{"tradeHFAccounts"}).
\item \code{currency} (character): Currency code.
\item \code{balance} (numeric): Total balance.
\item \code{available} (numeric): Amount available for trading or withdrawal.
\item \code{holds} (numeric): Amount locked or held.
\item \code{baseCurrency} (character): Base currency code.
\item \code{baseCurrencyPrice} (numeric): Price of the base currency.
\item \code{baseAmount} (numeric): Amount in the base currency.
\item \code{tag} (character): Tag associated with the account.
}
}
\description{
Retrieves paginated Spot sub-account information from KuCoin asynchronously, aggregating balance details into a single \code{data.table}. This internal function is designed for use within an R6 class and is not intended for direct end-user consumption.
}
\details{
\subsection{Workflow Overview}{
\enumerate{
\item \strong{Pagination Initialisation}: Sets an initial query with \code{currentPage = 1} and the specified \code{page_size}.
\item \strong{Page Fetching}: Defines an asynchronous helper function (\code{fetch_page}) to send a GET request for a given page, constructing the URL with current query parameters and authentication headers.
\item \strong{Automatic Pagination}: Leverages \code{auto_paginate} to repeatedly call \code{fetch_page}, aggregating results until all pages are retrieved or \code{max_pages} is reached.
\item \strong{Aggregation}: Processes each sub-account's account type arrays, converting them into \code{data.table}s with an added \code{accountType} column, and combines them into a single \code{data.table} with \code{subUserId} and \code{subName}.
}
}

\subsection{API Endpoint}{

\verb{GET https://api.kucoin.com/api/v2/sub-accounts}
}

\subsection{Usage}{

Utilised internally to provide detailed balance information for all sub-accounts associated with a KuCoin master account.
}

\subsection{Official Documentation}{

\href{https://www.kucoin.com/docs-new/rest/account-info/sub-account/get-subaccount-list-spot-balance-v2}{KuCoin Get Sub-Account List - Spot Balance (V2)}

\strong{Raw Response Schema}:
\itemize{
\item \code{code} (string): Status code, where \code{"200000"} indicates success.
\item \code{data} (object): Contains pagination metadata and an \code{items} array with sub-account details.
}

Example JSON response:

\if{html}{\out{<div class="sourceCode json">}}\preformatted{\{
    "code": "200000",
    "data": \{
        "currentPage": 1,
        "pageSize": 10,
        "totalNum": 3,
        "totalPage": 1,
        "items": [
            \{
                "subUserId": "63743f07e0c5230001761d08",
                "subName": "testapi6",
                "mainAccounts": [
                    \{
                        "currency": "USDT",
                        "balance": "0.01",
                        "available": "0.01",
                        "holds": "0",
                        "baseCurrency": "BTC",
                        "baseCurrencyPrice": "62514.5",
                        "baseAmount": "0.00000015",
                        "tag": "DEFAULT"
                    \}
                ],
                "tradeAccounts": [
                    \{
                        "currency": "USDT",
                        "balance": "0.01",
                        "available": "0.01",
                        "holds": "0",
                        "baseCurrency": "BTC",
                        "baseCurrencyPrice": "62514.5",
                        "baseAmount": "0.00000015",
                        "tag": "DEFAULT"
                    \}
                ],
                "marginAccounts": [
                    \{
                        "currency": "USDT",
                        "balance": "0.01",
                        "available": "0.01",
                        "holds": "0",
                        "baseCurrency": "BTC",
                        "baseCurrencyPrice": "62514.5",
                        "baseAmount": "0.00000015",
                        "tag": "DEFAULT"
                    \}
                ],
                "tradeHFAccounts": []
            \},
            \{
                "subUserId": "670538a31037eb000115b076",
                "subName": "Name1234567",
                "mainAccounts": [],
                "tradeAccounts": [],
                "marginAccounts": [],
                "tradeHFAccounts": []
            \},
            \{
                "subUserId": "66b0c0905fc1480001c14c36",
                "subName": "LTkucoin1491",
                "mainAccounts": [],
                "tradeAccounts": [],
                "marginAccounts": [],
                "tradeHFAccounts": []
            \}
        ]
    \}
\}
}\if{html}{\out{</div>}}
\itemize{
\item The function handles pagination automatically, fetching all pages up to \code{max_pages}.
\item Balance fields are converted from character to numeric types.
\item Sub-accounts with no balance entries are not included in the resulting \code{data.table}.
}
}
}
\examples{
\dontrun{
keys <- get_api_keys()
base_url <- "https://api.kucoin.com"
main_async <- coro::async(function() {
  dt <- await(get_spot_subaccount_list_v2_impl(
    keys = keys,
    base_url = base_url,
    page_size = 50,
    max_pages = 2
  ))
  print(dt)
})
main_async()
while (!later::loop_empty()) later::run_now()
}
}
